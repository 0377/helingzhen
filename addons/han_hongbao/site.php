<?php 

defined('IN_IA') or exit('Access Denied'); require_once('phpexcel/Classes/PHPExcel.php'); require_once "jssdk.php"; define('DS', DIRECTORY_SEPARATOR); class Han_hongbaoModuleSite extends WeModuleSite { public function doWebRecordlist() { global $_W, $_GPC; $op= $_GPC['op'] ? $_GPC['op'] : 'display'; $uniacid = $_W['uniacid']; if($op == 'display'){ $sql = ""; $params = array(); if(!empty($_GPC['arc_name'])){ $sql .= ' and `arc_name` like \'%'.$_GPC["arc_name"].'%\''; $params[':arc_name']=$_GPC['arc_name']; } $pindex = max(1, intval($_GPC['page'])); $psize = 20; $list = pdo_fetchall("SELECT * FROM " . tablename('han_hongbao_recordlist') . " WHERE weid = '{$_W['uniacid']}' ".$sql." ORDER BY get_time DESC LIMIT " . ($pindex - 1) * $psize . ',' . $psize, $params); $total = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('han_hongbao_recordlist') . " WHERE weid = '{$_W['uniacid']}' ".$sql, $params); $pager = pagination($total, $pindex, $psize); }else if($op == 'delete'){ $id = intval($_GPC['id']); pdo_delete('han_hongbao_recordlist', array('id' => $id)); message("手动发红包记录删除成功!", referer(), "success"); }else if($op == 'deleteall'){ foreach ($_GPC['idArr'] as $k => $id) { $id = intval($id); pdo_delete("han_hongbao_recordlist", array("id" => $id)); } message("手动发红包记录删除成功!", referer(), "success"); } include $this->template('recordlist'); } public function doWebManual() { global $_W, $_GPC; $op= $_GPC['op'] ? $_GPC['op'] : 'post'; $uniacid = $_W['uniacid']; $type=intval($_GPC['type']); load()->model('mc'); $groups = mc_groups(); $access_token = $this->get_access_token(); $setting = $this->module['config']['api']; $mchid=$setting['mchid']; $password=$setting['password']; $appid=$setting['appid']; $send_name = $setting['send_name']; $wishing = $setting['wishing']; $remark = $setting['remark']; if(empty($remark)){$remark='good luck!';} $ip = $setting['ip']; if($_GPC['submit']=='执行'){ $act_name = '手动发红包'; if($type==0){ $re_openid = $_GPC['openid']; $fans_info = pdo_fetch("SELECT * FROM " .tablename('mc_mapping_fans'). " WHERE uniacid='{$_W['uniacid']}' AND openid='{$re_openid}' LIMIT 1"); if(empty($fans_info)){ message("该粉丝信息不存在，请填写正确的openid!", referer(), "error"); } $total_amount = $_GPC['money']; if(empty($total_amount)||$total_amount<100||$total_amount>20000){ message("红包金额不合法，请正确填写100~20000!", referer(), "error"); } $nick_name = $fans_info['nickname']; $responseObj = $this->pay($mchid,$password,$appid,$nick_name,$send_name,$re_openid,$total_amount,$wishing,$ip,$act_name,$remark); $result_code=$responseObj->result_code; $total_amount=$responseObj->total_amount; $return_msg = $responseObj->return_msg; $data = array( 'weid' => $uniacid, 'uid' => $fans_info['uid'], 'type' =>'手动发红包', 'arc_name' =>$act_name, 'nick_name' => $nick_name, 'openid' => $re_openid, 'get_money' =>$total_amount, 'get_time' =>TIMESTAMP, 'get_status' =>$result_code, ); if($result_code=='SUCCESS'){ $tmpxx = array ( 'first' => array('value' => $act_name), 'keyword1' => array('value' => '提供方：'.$send_name), 'keyword2' => array('value' => '接受人：'.$re_openid), 'remark' => array('value' => '你收到'.$act_name.'活动发放的红包'.($total_amount*0.01).'元') ); $acc = WeAccount::create($_W['acid']); $acc->sendTplNotice($re_openid,$settings['mid'],$tmpxx); $data['type'] = 'sd'; pdo_insert('han_hongbao_recordlist', $data); pdo_insert('han_hongbao_sdhb_history', $data); message($return_msg,referer(),'success'); }else{ pdo_insert('han_hongbao_sdhb_history', $data); message($return_msg, referer(), "error"); } unset($responseObj); unset($re_openid); unset($fans_info); } if($type==1){ $groupid = $_GPC['groupid']; if(empty($groupid)||$groupid==0){ message("请先选择粉丝分组再发放红包!", referer(), "error"); } $total_amount = $_GPC['moneys']; if(empty($total_amount)||$total_amount<100||$total_amount>20000){ message("红包金额不合法，请正确填写100~20000!", referer(), "error"); } $fans = pdo_fetchall("SELECT * FROM " .tablename('mc_mapping_fans'). " WHERE uniacid='{$_W['uniacid']}' AND groupid='{$groupid}'"); foreach($fans as $fans_info) { $nick_name = $fans_info['nickname']; $re_openid = $fans_info['openid']; $responseObj = $this->pay($mchid,$password,$appid,$nick_name,$send_name,$re_openid,$total_amount,$wishing,$ip,$act_name,$remark); $result_code=$responseObj->result_code; $total_amount=$responseObj->total_amount; $return_msg = $responseObj->return_msg; $data = array( 'weid' => $uniacid, 'uid' => $fans_info['uid'], 'type' =>'手动发红包', 'arc_name' =>$act_name, 'nick_name' => $nick_name, 'openid' => $re_openid, 'get_money' =>$total_amount, 'get_time' =>TIMESTAMP, 'get_status' =>$result_code, ); if($result_code=='SUCCESS'){ $tmpxx = array ( 'first' => array('value' => $act_name), 'keyword1' => array('value' => '提供方：'.$send_name), 'keyword2' => array('value' => '接受人：'.$re_openid), 'remark' => array('value' => '你收到'.$act_name.'活动发放的红包'.($total_amount*0.01).'元') ); $acc = WeAccount::create($_W['acid']); $acc->sendTplNotice($re_openid,$settings['mid'],$tmpxx); $data['type'] = 'sd'; pdo_insert('han_hongbao_recordlist', $data); } pdo_insert('han_hongbao_sdhb_history', $data); unset($responseObj); unset($re_openid); unset($fans_info); } } if($type==2){ $fans = pdo_fetchall("SELECT * FROM " .tablename('han_hongbao_sdhb'). " WHERE uniacid='{$_W['uniacid']}'"); foreach($fans as $fans_info) { $nick_name = $fans_info['nickname']; $re_openid = $fans_info['openid']; $total_amount = $fans_info['money']; $responseObj = $this->pay($mchid,$password,$appid,$nick_name,$send_name,$re_openid,$total_amount,$wishing,$ip,$act_name,$remark); $result_code=$responseObj->result_code; $total_amount=$responseObj->total_amount; $return_msg = $responseObj->return_msg; $data = array( 'weid' => $uniacid, 'uid' => $fans_info['uid'], 'type' =>'手动发红包', 'arc_name' =>$act_name, 'nick_name' => $nick_name, 'openid' => $re_openid, 'get_money' =>$total_amount, 'get_time' =>TIMESTAMP, 'get_status' =>$result_code, ); if($result_code=='SUCCESS'){ pdo_delete('han_hongbao_sdhb', array('id' => $fans_info['id'])); $tmpxx = array ( 'first' => array('value' => $act_name), 'keyword1' => array('value' => '提供方：'.$send_name), 'keyword2' => array('value' => '接受人：'.$re_openid), 'remark' => array('value' => '你收到'.$act_name.'活动发放的红包'.($total_amount*0.01).'元') ); $acc = WeAccount::create($_W['acid']); $acc->sendTplNotice($re_openid,$settings['mid'],$tmpxx); $data['type'] = 'sd'; pdo_insert('han_hongbao_recordlist', $data); } pdo_insert('han_hongbao_sdhb_history', $data); unset($responseObj); unset($re_openid); unset($fans_info); } } } if($_GPC['submit']=='导出'){ $data = pdo_fetchall("SELECT `nickname`,`openid`,`money` FROM " . tablename('han_hongbao_sdhb') . " WHERE uniacid = '{$_W['uniacid']}' "); $excel = new PHPExcel(); $letter = array('A','B','C'); $tableheader = array('昵称','粉丝id','红包金额'); for($i = 0;$i < count($tableheader);$i++) { $excel->getActiveSheet()->setCellValue("$letter[$i]1","$tableheader[$i]"); } for ($i = 2;$i <= count($data) + 1;$i++) { $j = 0; foreach ($data[$i - 2] as $key=>$value) { $excel->getActiveSheet()->setCellValue("$letter[$j]$i","$value"); $j++; } } $write = new PHPExcel_Writer_Excel5($excel); header("Pragma: public"); header("Expires: 0"); header("Cache-Control:must-revalidate, post-check=0, pre-check=0"); header("Content-Type:application/force-download"); header("Content-Type:application/vnd.ms-execl"); header("Content-Type:application/octet-stream"); header("Content-Type:application/download");; header('Content-Disposition:attachment;filename="sdhbTemplate.xls"'); header("Content-Transfer-Encoding:binary"); $write->save('php://output'); return; } if($_GPC['submit']=='导入'){ if (! empty ( $_FILES ['excelfile'] ['name'] )){ $tmp_file = $_FILES ['excelfile'] ['tmp_name']; $file_types = explode ( ".", $_FILES ['excelfile'] ['name'] ); $file_type = $file_types [count ( $file_types ) - 1]; if (strtolower ( $file_type ) != "xls" && strtolower ( $file_type ) != "xlsx"){ $this->error ( '不是Excel文件，重新上传' ); echo strtolower ( '不是Excel文件，重新上传' ); } $savePath = IA_ROOT . '/addons/han_hongbao/excel/'; $file_name = TIMESTAMP. "." . $file_type; load()->func('file'); if (! file_move($tmp_file, $savePath . $file_name)){ $this->error ( '上传失败' ); echo ( '上传失败:tmp_file '.$tmp_file . ' savePath:' .$savePath . $file_name ); } $objPHPExcel = PHPExcel_IOFactory::load($savePath . $file_name ); $sheet = $objPHPExcel->getSheet(0); $highestRow = $sheet->getHighestRow(); $highestColumm = $sheet->getHighestColumn(); $time = TIMESTAMP; for ($row = 2; $row <= $highestRow; $row++){ for ($column = 'A'; $column <= $highestColumm; $column++) { $dataset[] = $sheet->getCell($column.$row)->getValue(); if ($column == 'A') {$nickname = $sheet->getCell($column.$row)->getValue();} if ($column == 'B') {$openid = $sheet->getCell($column.$row)->getValue();} if ($column == 'C') {$money = $sheet->getCell($column.$row)->getValue();} } if (empty($money) || empty($openid) || empty($nickname)) {continue;} $reck = pdo_fetchall("SELECT * FROM " . tablename('han_hongbao_sdhb') . " WHERE uniacid = '{$_W['uniacid']}' and `openid`='".$openid."'"); if(!empty($reck)){continue;} $sql = 'INSERT INTO'.tablename('han_hongbao_sdhb') .' (`uniacid`,`nickname`,`openid`,`money`) values ('. strval($_W['uniacid']).',\''.$nickname.'\',\''.$openid.'\','.$money.')'; $result = pdo_query($sql); } message('导入成功',referer(),'success'); } } if($op == 'display'){ $sql = ""; $params = array(); $pindex = max(1, intval($_GPC['page'])); $psize = 20; $list = pdo_fetchall("SELECT * FROM " . tablename('han_hongbao_sdhb_history') . " WHERE weid = '{$_W['uniacid']}' $sql ORDER BY get_time DESC LIMIT " . ($pindex - 1) * $psize . ',' . $psize, $params); $total = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('han_hongbao_sdhb_history') . " WHERE weid = '{$_W['uniacid']}' $sql", $params); $pager = pagination($total, $pindex, $psize); }else if($op == 'delete'){ $id = intval($_GPC['id']); pdo_delete('han_hongbao_sdhb_history', array('id' => $id)); message("手动发红包记录删除成功!", referer(), "success"); }else if($op == 'deleteall'){ foreach ($_GPC['idArr'] as $k => $id) { $id = intval($id); pdo_delete("han_hongbao_sdhb_history", array("id" => $id)); } message("手动发红包记录删除成功!", referer(), "success"); } include $this->template('manualset'); } public function doWebKouling() { global $_W, $_GPC; $op= $_GPC['op'] ? $_GPC['op'] : 'post'; $weid =$_W['uniacid']; if($_GPC['submit']=='确定'){ $data =array( 'uniacid'=>$_W['uniacid'], 'kouling'=>rand(100000,999999), 'money_min'=>$_GPC['minmoney'], 'money_max'=>$_GPC['maxmoney'], 'count'=>intval($_GPC['mscount']), 'days'=>intval($_GPC['msday']), 'createtime'=>TIMESTAMP ); $counts=intval($_GPC['klcount']); for($i = 0;$i < $counts;$i++) { $data['kouling']=rand(100000,999999); pdo_insert('han_hongbao_kouling', $data); } message("口令信息新增成功!", referer(), "success"); } if($_GPC['submit']=='导出'){ $data = pdo_fetchall("SELECT `kouling`,`money_min`,`money_max`,`count`,round(`days`-(".TIMESTAMP."-`createtime`)/86400,2) as days FROM " . tablename('han_hongbao_kouling') . " WHERE uniacid = '{$_W['uniacid']}' "); $excel = new PHPExcel(); $letter = array('A','B','C','D','E'); $tableheader = array('口令','最低金额','最高金额','剩余次数','有效天数'); for($i = 0;$i < count($tableheader);$i++) { $excel->getActiveSheet()->setCellValue("$letter[$i]1","$tableheader[$i]"); } for ($i = 2;$i <= count($data) + 1;$i++) { $j = 0; foreach ($data[$i - 2] as $key=>$value) { $excel->getActiveSheet()->setCellValue("$letter[$j]$i","$value"); $j++; } } $write = new PHPExcel_Writer_Excel5($excel); header("Pragma: public"); header("Expires: 0"); header("Cache-Control:must-revalidate, post-check=0, pre-check=0"); header("Content-Type:application/force-download"); header("Content-Type:application/vnd.ms-execl"); header("Content-Type:application/octet-stream"); header("Content-Type:application/download");; header('Content-Disposition:attachment;filename="koulingTemplate.xls"'); header("Content-Transfer-Encoding:binary"); $write->save('php://output'); return; } if($_GPC['submit']=='导入'){ if (! empty ( $_FILES ['excelfile'] ['name'] )){ $tmp_file = $_FILES ['excelfile'] ['tmp_name']; $file_types = explode ( ".", $_FILES ['excelfile'] ['name'] ); $file_type = $file_types [count ( $file_types ) - 1]; if (strtolower ( $file_type ) != "xls" && strtolower ( $file_type ) != "xlsx"){ $this->error ( '不是Excel文件，重新上传' ); echo strtolower ( '不是Excel文件，重新上传' ); } $savePath = IA_ROOT.'/excel/'; $str = 'lastExcel'; $file_name = $str . "." . $file_type; load()->func('file'); if (! file_move($tmp_file, $savePath . $file_name)){ $this->error ( '上传失败' ); echo ( '上传失败:tmp_file '.$tmp_file . ' savePath:' .$savePath . $file_name ); } $objPHPExcel = PHPExcel_IOFactory::load($savePath . $file_name ); $sheet = $objPHPExcel->getSheet(0); $highestRow = $sheet->getHighestRow(); $highestColumm = $sheet->getHighestColumn(); $time = TIMESTAMP; for ($row = 2; $row <= $highestRow; $row++){ for ($column = 'A'; $column <= $highestColumm; $column++) { $dataset[] = $sheet->getCell($column.$row)->getValue(); if ($column == 'A'){$userIDCard = $sheet->getCell($column.$row)->getValue();} if ($column == 'B') {$moneymin = $sheet->getCell($column.$row)->getValue();} if ($column == 'C') {$moneymax = $sheet->getCell($column.$row)->getValue();} if ($column == 'D') {$count = $sheet->getCell($column.$row)->getValue(); } if ($column == 'E') {$days = $sheet->getCell($column.$row)->getValue(); } } $kouling = $userIDCard; if (empty($moneymin) || empty($moneymax) || empty($kouling)) {continue;} $reck = pdo_fetchall("SELECT * FROM " . tablename('han_hongbao_kouling') . " WHERE uniacid = '{$_W['uniacid']}' and `kouling`='".$kouling."'"); if(!empty($reck)){continue;} $sql = 'INSERT INTO'.tablename('han_hongbao_kouling') .' (`uniacid`,`createtime`,`kouling`,`count`,`money_min`,`money_max`,`days`) values ('. strval($_W['uniacid']).','.$time.',\''.$kouling.'\','.$count.','.$moneymin.','.$moneymax.' ,'.$days.')'; $result = pdo_query($sql); } message('导入成功',referer(),'success'); } } if($op == 'display'){ $sql = ""; $params = array(); if($_GPC['submit']=='查询'){ $createBgTime = strtotime($_GPC['time']['start']); $createEdTime = strtotime($_GPC['time']['end']); $sql = "and `createtime` >= :createBgTime and `createtime` <= :createEdTime"; if(!empty($_GPC["content"])){ $sql=$sql . ' and `kouling` like \'%'.$_GPC["content"].'%\''; } $params = array(':createBgTime'=> $createBgTime,':createEdTime' =>$createEdTime); } $pindex = max(1, intval($_GPC['page'])); $psize = 20; $list = pdo_fetchall("SELECT `id`,`kouling`,`money_min`,`money_max`,`count`,`days`, `createtime` FROM " . tablename('han_hongbao_kouling') . " WHERE uniacid = '{$_W['uniacid']}' ".$sql." ORDER BY createtime DESC LIMIT " . ($pindex - 1) * $psize . ',' . $psize, $params); $total = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('han_hongbao_kouling') . " WHERE uniacid = '{$_W['uniacid']}' ".$sql, $params); $pager = pagination($total, $pindex, $psize); }else if($op == 'delete'){ $id = intval($_GPC['id']); pdo_delete('han_hongbao_kouling', array('id' => $id)); message("口令信息删除成功!", referer(), "success"); }else if($op == 'post'){ $id=$_GPC['id']; load()->model('module'); $url_show = murl('entry', array('do' => 'kouling', 'm' => 'han_hongbao'), true, true); $hours_time = pdo_fetchall("SELECT * FROM " . tablename('han_hongbao_time')); $set= pdo_fetch("SELECT * FROM ".tablename('han_hongbao_klset')." WHERE weid=:weid limit 1", array(':weid' => $weid)); $work_time = unserialize($set['hours_time']); load()->model('mc'); $groups = mc_groups(); $genders = array(0=>'不限制',1=>'只限男',2=>'只限女'); $gender = unserialize($set['gender']); $keywords = pdo_fetchcolumn('SELECT content FROM ' . tablename('rule_keyword') . ' WHERE id = :id AND uniacid = :uniacid ', array(':id' => $set['kid'], ':uniacid' => $_W['uniacid'])); if(checksubmit('submit')) { $citys = array(); foreach ($_GPC['citys'] as $value) { if (!empty($value)) $citys[] = $value; } if (!empty($citys)) $citys = serialize($citys); else $citys = ''; $data=array( 'weid'=>$weid, 'act_name'=>$_GPC['act_name'], 'is_open'=>$_GPC['is_open'], 'up_img'=>$_GPC['up_img'], 'day_total'=>$_GPC['day_total'], 'total'=>$_GPC['total'], 'cool_time'=>$_GPC['cool_time'], 'check'=>$_GPC['check'], 'hours_time'=>serialize($_POST['hours']), 'remark'=>htmlspecialchars_decode(str_replace('&quot;','&#039;',$_GPC['remark']),ENT_QUOTES), 'refail'=>htmlspecialchars_decode(str_replace('&quot;','&#039;',$_GPC['refail']),ENT_QUOTES), 'title'=>$_GPC['title'], 'description'=>htmlspecialchars_decode(str_replace('&quot;','&#039;',$_GPC['description']),ENT_QUOTES), 'bgimge'=>$_GPC['bgimge'], 'shareimg'=>$_GPC['shareimg'], 'bgimg'=>$_GPC['bgimg'], 'prompt'=>$_GPC['prompt'], 'rule'=>$_GPC['rule'], 'oauth'=>$_GPC['oauth'], 'redirect'=>$_GPC['redirect'], 'gender'=>serialize($_GPC['genders']), 'province'=>$_GPC['place']['province'], 'city'=>$citys, 'area'=>$_GPC['place']['district'], 'need_rgst'=>$_GPC['need_rgst'], 'mem_group'=>$_GPC['mem_group'] ); if(!empty($_GPC['keyword'])) { $rule['uniacid'] = $_W['uniacid']; $rule['name'] = $_GPC['title'] . ' 触发规则'; $rule['module'] = 'cover'; $rule['status'] = 1; $keyword = array('uniacid' => $_W['uniacid']); $keyword['module'] = 'cover'; $keyword['content'] = $_GPC['keyword']; $keyword['status'] = 1; $keyword['type'] = 1; $keyword['displayorder'] = 1; $reply = array('uniacid' => $_W['uniacid']); $reply['title'] = $_GPC['title']; $reply['module'] = 'han_hongbao'; $reply['do'] = 'kouling'; $reply['description'] = htmlspecialchars_decode(str_replace('&quot;','&#039;',$_GPC['description']),ENT_QUOTES); $reply['thumb'] = $data['bgimge']; $reply['url'] = murl('entry/module/kouling', array('m'=>'han_hongbao','id' => $id)); } if(empty($id)) { if(!empty($_GPC['keyword'])) { pdo_insert('rule', $rule); $rid = pdo_insertid(); $keyword['rid'] = $rid; pdo_insert('rule_keyword', $keyword); $kid = pdo_insertid(); $reply['rid'] = $rid; pdo_insert('cover_reply', $reply); $data['rid'] = $rid; $data['kid'] = $kid; } pdo_insert('han_hongbao_klset', $data); $aid = pdo_insertid(); pdo_update('cover_reply', array('url' => murl('entry/module/kouling', array('m'=>'han_hongbao', 'id' => $aid))), array('rid' => $rid)); }else{ pdo_delete('rule', array('id' => $set['rid'], 'uniacid' => $_W['uniacid'])); pdo_delete('rule_keyword', array('rid' => $set['rid'], 'uniacid' => $_W['uniacid'])); pdo_delete('cover_reply', array('rid' => $set['rid'])); if(!empty($_GPC['keyword'])) { pdo_insert('rule', $rule); $rid = pdo_insertid(); $keyword['rid'] = $rid; pdo_insert('rule_keyword', $keyword); $kid = pdo_insertid(); $reply['rid'] = $rid; pdo_insert('cover_reply', $reply); $data['rid'] = $rid; $data['kid'] = $kid; } else { $data['rid'] = 0; $data['kid'] = 0; } pdo_update('han_hongbao_klset',$data, array('id' => $id)); } message('口令红包设置成功！','refresh', 'success'); } }else if($op == 'deleteall') { foreach ($_GPC['idArr'] as $k => $id) { $id = intval($id); pdo_delete("han_hongbao_kouling", array("id" => $id)); } message("口令信息删除成功!", referer(), "success"); }else if($op == 'clean'){ $sql = 'delete from '.tablename('han_hongbao_kouling').' where uniacid ='.$_W['uniacid']; pdo_query($sql); message("领取记录删除成功!", referer(), "success"); }else if($op == 'addkl'){ $data =array( 'uniacid'=>$_W['uniacid'], 'kouling'=>$_GPC['kouling'], 'money_min'=>$_GPC['money_min'], 'money_max'=>$_GPC['money_max'], 'count'=>intval($_GPC['count']), 'days'=>intval($_GPC['days']), 'createtime'=>TIMESTAMP ); $reck = pdo_fetchall("SELECT * FROM " . tablename('han_hongbao_kouling') . " WHERE uniacid = '{$_W['uniacid']}' and `kouling`='{$_GPC['kouling']}'"); if(empty($reck)){ pdo_insert('han_hongbao_kouling', $data); message("口令信息新增成功!", referer(), "success"); }else{ message('该口令已存在!',referer(),'error'); } } include $this->template('kllist'); } public function doWebKlhb() { global $_W, $_GPC; $weid =$_W['uniacid']; $op= $_GPC['op'] ? $_GPC['op'] : 'display'; $access_token = $this->get_access_token(); $setting = $this->module['config']['api']; $set= pdo_fetch("SELECT * FROM ".tablename('han_hongbao_klset')." WHERE weid=:weid limit 1", array(':weid' => $weid)); $mchid=$setting['mchid']; $password=$setting['password']; $appid=$setting['appid']; $send_name = $setting['send_name']; $wishing = $setting['wishing']; $remark = $setting['remark']; if(empty($remark)){$remark='good luck!';} $ip = $setting['ip']; if($op == 'display'){ $sql = ""; $params = array(); if(!empty($_GPC["nickname"])){ $sql=$sql . ' and `nick_name` like \'%'.$_GPC["nickname"].'%\''; } $pindex = max(1, intval($_GPC['page'])); $psize = 20; $list = pdo_fetchall("SELECT * FROM " . tablename('han_hongbao_klrecord') . " WHERE uniacid = '{$_W['uniacid']}' ".$sql." ORDER BY time DESC LIMIT " . ($pindex - 1) * $psize . ',' . $psize, $params); $total = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('han_hongbao_klrecord') . " WHERE uniacid = '{$_W['uniacid']}' ".$sql, $params); $pager = pagination($total, $pindex, $psize); }else if($op == 'delete'){ $id = intval($_GPC['id']); pdo_delete('han_hongbao_klrecord', array('id' => $id)); message("口令信息删除成功!", referer(), "success"); }else if($op == 'deleteall') { foreach ($_GPC['idArr'] as $k => $id) { $id = intval($id); pdo_delete("han_hongbao_klrecord", array("id" => $id)); } message("领取记录删除成功!", referer(), "success"); }else if($op == 'check'){ $id = intval($_GPC['id']); $record= pdo_fetch("SELECT * FROM ".tablename('han_hongbao_klrecord')." WHERE state='check' and id=:id limit 1", array(':id' =>$id)); $nick_name = $record['nick_name']; $total_amount = $record['moneyCount']*100; $re_openid = $record['openid']; $content = $record['content']; $act_name = $set['act_name']; $responseObj = $this->pay($mchid,$password,$appid,$nick_name,$send_name,$re_openid,$total_amount,$wishing,$ip,$act_name,$remark); $result_code=$responseObj->result_code; $return_msg = $responseObj->return_msg; $time = date('Y-m-d H:i:s',time()); $data = array( 'moneyCount' =>$total_amount*0.01, 'time' =>$time, 'state' =>$result_code, ); pdo_update('han_hongbao_klrecord',$data, array('id' => $id)); if($result_code=='SUCCESS'){ $rst = array( 'weid' => $weid, 'type' =>'kl', 'arc_name' =>$act_name, 'nick_name' => $nick_name, 'openid' => $re_openid, 'get_money' =>$total_amount, 'get_time' =>TIMESTAMP, 'get_status' =>$result_code, ); pdo_insert('han_hongbao_recordlist', $rst); $sql = 'SELECT * FROM ' . tablename('han_hongbao_kouling') . ' WHERE `uniacid` = :uniacid  and `kouling` = :kouling'; $params = array(':uniacid' => $_W['uniacid'] , ':kouling' => $content); $result = pdo_fetch($sql, $params); $kouling_count=$result['count']; $sql = 'update '.tablename('han_hongbao_kouling') .' set `count` = '.strval($kouling_count-1).'  WHERE `uniacid` = '.$_W['uniacid'].' and `kouling` = \''.$content.'\''; pdo_query($sql); message("口令红包发放成功!", referer(), "success"); }else{ message($return_msg.",口令红包发放失败!", referer(), "error"); } }else if($op == 'checkall'){ foreach ($_GPC['idArr'] as $k => $id) { $id = intval($id); $record= pdo_fetch("SELECT * FROM ".tablename('han_hongbao_klrecord')." WHERE state='check' and id=:id limit 1", array(':id' =>$id)); $nick_name = $record['nick_name']; $total_amount = $record['moneyCount']*100; $re_openid = $record['openid']; $act_name = $set['act_name']; $responseObj = $this->pay($mchid,$password,$appid,$nick_name,$send_name,$re_openid,$total_amount,$wishing,$ip,$act_name,$remark); $result_code=$responseObj->result_code; $return_msg = $responseObj->return_msg; $time = date('Y-m-d H:i:s',time()); $data = array( 'moneyCount' =>$total_amount*0.01, 'time' =>$time, 'state' =>$result_code, ); pdo_update('han_hongbao_klrecord',$data, array('id' => $id)); if($result_code=='SUCCESS'){ $rst = array( 'weid' => $weid, 'type' =>'kl', 'arc_name' =>$act_name, 'nick_name' => $nick_name, 'openid' => $re_openid, 'get_money' =>$total_amount, 'get_time' =>TIMESTAMP, 'get_status' =>$result_code, ); pdo_insert('han_hongbao_recordlist', $rst); $sql = 'SELECT * FROM ' . tablename('han_hongbao_kouling') . ' WHERE `uniacid` = :uniacid  and `kouling` = :kouling'; $params = array(':uniacid' => $_W['uniacid'] , ':kouling' => $content); $result = pdo_fetch($sql, $params); $kouling_count=$result['count']; $sql = 'update '.tablename('han_hongbao_kouling') .' set `count` = '.strval($kouling_count-1).'  WHERE `uniacid` = '.$_W['uniacid'].' and `kouling` = \''.$content.'\''; pdo_query($sql); } } message("批量操作成功，请检查是否发放成功!", referer(), "success"); } include $this->template('klrecord'); } public function doMobileSendkouling(){ include_once("WxHongBaoHelper.php"); include_once("CommonUtil.php"); include_once("MD5SignUtil.php"); include_once("PZHSendMoney.php"); global $_GPC,$_W; $set= pdo_fetch("SELECT * FROM ".tablename('han_hongbao_klset')." WHERE weid=:weid limit 1", array(':weid' => $_W['uniacid'])); $setting = $this->module['config']['api']; $access_token = $this->get_access_token(); $content = $_GPC['kouling']; $serverId = $_GPC['serverId']; $result= pdo_fetch("SELECT * FROM ".tablename('han_hongbao_kouling')." WHERE `count`> 0 and `days`-(".TIMESTAMP."-`createtime`)/86400>0 and uniacid=:uniacid and kouling=:kouling limit 1", array(':uniacid' => $_W['uniacid'],':kouling'=>$content)); $worktimes = unserialize($set['hours_time']); $num=0; $hour = intval(date("G")); foreach($worktimes as $k => $val){ if($val>$hour&&($val-1)==$hour){ $num+=1; } } if($set['is_open']==0){ $postarr='{"touser":"'.$_W['openid'].'","msgtype":"text","text":{"content":"'.$set['refail'].'"}}'; $res = ihttp_post('https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=' . $access_token, $postarr); echo "口令红包未开启！"; return; } if($num==0){ $postarr='{"touser":"'.$_W['openid'].'","msgtype":"text","text":{"content":"'.$set['refail'].'"}}'; $res = ihttp_post('https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=' . $access_token, $postarr); echo "亲，还未到红包发放时间！"; return; } if(empty($content)){ $postarr='{"touser":"'.$_W['openid'].'","msgtype":"text","text":{"content":"'.$set['refail'].'"}}'; $res = ihttp_post('https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=' . $access_token, $postarr); echo "没有接收到口令"; return; } $re_openid = $_W['openid']; if(empty($re_openid)){ $postarr='{"touser":"'.$_W['openid'].'","msgtype":"text","text":{"content":"'.$set['refail'].'"}}'; $res = ihttp_post('https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=' . $access_token, $postarr); echo '获取不到openid'; return; } $nick_name = $_W['fans']['nickname']; $send_name = $setting['send_name']; $wishing = $setting['wishing']; $remark = $setting['remark']; $act_name = $set['act_name']; $mchid=$setting['mchid']; $appid=$setting['appid']; $password=$setting['secret']; $maxCount = $set['total']; $maxRedCount = $set['total']; session_start(); if($_W['timestamp']-$_SESSION[$re_openid]<$set['cool_time']*3600){ $postarr='{"touser":"'.$_W['openid'].'","msgtype":"text","text":{"content":"'.$set['refail'].'"}}'; $res = ihttp_post('https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=' . $access_token, $postarr); $errorMsg='您的操作过于频繁'; $_SESSION[$re_openid] = $_W['timestamp']; echo $errorMsg; return; }else{ $_SESSION[$re_openid] =$_W['timestamp']; } $kouling_count=$result['count']; if(!$result||$result['count']<=0){ $postarr='{"touser":"'.$_W['openid'].'","msgtype":"text","text":{"content":"'.$set['refail'].'"}}'; $res = ihttp_post('https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=' . $access_token, $postarr); echo '没有查到该口令'; return; } if($result['days']-(TIMESTAMP-$result['createtime'])/86400<=0){ $postarr='{"touser":"'.$_W['openid'].'","msgtype":"text","text":{"content":"'.$set['refail'].'"}}'; $res = ihttp_post('https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=' . $access_token, $postarr); echo '该口令已过期'; return; } $moneyCount = rand($result['money_min'],$result['money_max']); if(empty($moneyCount)){ $postarr='{"touser":"'.$_W['openid'].'","msgtype":"text","text":{"content":"'.$set['refail'].'"}}'; $res = ihttp_post('https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=' . $access_token, $postarr); echo '金额不能为空'; return ; } $sql = 'SELECT redPackCount,lastTime FROM ' . tablename('han_hongbao_klfans') . ' WHERE `uniacid` = :uniacid and `type` = :type and `openid` = :openid'; $params = array(':uniacid' => $_W['uniacid'],':type' => 'kouling' , ':openid' => $re_openid); $account = pdo_fetch($sql, $params); if(!$account){ $sql = 'INSERT INTO'.tablename('han_hongbao_klfans') .' (`uniacid`,`openid`,`redPackCount`,`lastTime`,`type`) values ('. strval($_W['uniacid']).',\''.$re_openid.'\',0,'.strval($_W['timestamp']).',\'kouling\')'; $result = pdo_query($sql); }else{ if($account['redPackCount']>=$maxCount){ $postarr='{"touser":"'.$_W['openid'].'","msgtype":"text","text":{"content":"'.$set['refail'].'"}}'; $res = ihttp_post('https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=' . $access_token, $postarr); echo '您的红包领取达到限制'; return; } } $sql_bf = 'SELECT * FROM ' . tablename('han_hongbao_kouling') . ' WHERE `uniacid` = :uniacid  and `kouling` = :kouling'; $params = array(':uniacid' => $_W['uniacid'] , ':kouling' => $content); $result = pdo_fetch($sql_bf, $params); $kouling_count=$result['count']; $sql_bf = 'update '.tablename('han_hongbao_kouling') .' set `count` = '.strval($kouling_count-1).'  WHERE `uniacid` = '.$_W['uniacid'].' and `kouling` = \''.$content.'\''; pdo_query($sql_bf); $weid = $_W['uniacid']; $time = date('Y-m-d H:i:s',time()); $imgurl = ""; if($set['up_img'] == '1'){ load()->func('file'); mkdirs("../attachment/images/" .$_W['uniacid']."/". date("Y/m/d")); $destination_folder = "../attachment/images/" .$_W['uniacid']."/". date("Y/m/d") . "/"; if (!file_exists($destination_folder)) { mkdir($destination_folder); } if (!empty($serverId)) { $imgurl = $this->getMediaImg($serverId, $destination_folder); } else { echo '照片没有上传成功'; return; } } if($set['check']==0){ define('PARTNERKEY',$setting['password']); $mch_billno=$mchid.date('YmdHis').rand(1000, 9999); $commonUtil = new CommonUtil(); $wxHongBaoHelper = new WxHongBaoHelper(); $wxHongBaoHelper->setParameter("nonce_str", $commonUtil->create_noncestr()); $wxHongBaoHelper->setParameter("mch_billno", $mch_billno); $wxHongBaoHelper->setParameter("mch_id",$mchid); $wxHongBaoHelper->setParameter("wxappid", $appid); $wxHongBaoHelper->setParameter("nick_name",$nick_name); $wxHongBaoHelper->setParameter("send_name", $send_name); $wxHongBaoHelper->setParameter("re_openid", $_COOKIE['klhb_openid'.$weid]); $wxHongBaoHelper->setParameter("total_amount", $moneyCount); $wxHongBaoHelper->setParameter("min_value", $moneyCount); $wxHongBaoHelper->setParameter("max_value", $moneyCount); $wxHongBaoHelper->setParameter("total_num", 1); $wxHongBaoHelper->setParameter("wishing",$wishing ); $wxHongBaoHelper->setParameter("client_ip", $setting['ip']); $wxHongBaoHelper->setParameter("act_name", $act_name); $wxHongBaoHelper->setParameter("remark",$remark); $postXml = $wxHongBaoHelper->create_hongbao_xml(); $url = 'https://api.mch.weixin.qq.com/mmpaymkttransfers/sendredpack'; $responseXml = $wxHongBaoHelper->curl_post_ssll($url, $postXml,$_W['uniacid']); $responseObj = simplexml_load_string($responseXml, 'SimpleXMLElement', LIBXML_NOCDATA); $sql0 = 'INSERT INTO'.tablename('han_hongbao_klrecord') .' (`uniacid`,`openid`,`nick_name`,`moneyCount`,`time`,`type`,`state`,`imgurl`,`content`) values ('. strval($_W['uniacid']).',\''.$re_openid.'\''.',\''.$nick_name.'\','.strval($moneyCount/100.0).',\''.$time.'\',\'kouling\',\''.$responseObj->result_code.'\',\''.$imgurl.'\',\''.$content.'\')'; pdo_query($sql0); if($responseObj->result_code == 'FAIL' || $responseObj == 'fail'||!$responseObj->result_code ){ $sql = 'SELECT * FROM ' . tablename('han_hongbao_kouling') . ' WHERE `uniacid` = :uniacid  and `kouling` = :kouling'; $params = array(':uniacid' => $_W['uniacid'] , ':kouling' => $content); $result = pdo_fetch($sql, $params); $kouling_count=$result['count']; $sql = 'update '.tablename('han_hongbao_kouling') .' set `count` = '.strval($kouling_count+1).'  WHERE `uniacid` = '.$_W['uniacid'].' and `kouling` = \''.$content.'\''; pdo_query($sql); $postarr='{"touser":"'.$_W['openid'].'","msgtype":"text","text":{"content":"'.$set['refail'].'"}}'; $res = ihttp_post('https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=' . $access_token, $postarr); if (!$responseObj->result_code) { echo "系统错误，请稍后再试"; return; } $errorMsg=$responseObj->return_msg; echo $errorMsg; return; }else{ $postarr='{"touser":"'.$_W['openid'].'","msgtype":"text","text":{"content":"'.$set['remark'].'"}}'; $res = ihttp_post('https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=' . $access_token, $postarr); $sql = 'update '.tablename('han_hongbao_klfans') .'   set `redPackCount` = ' .strval($account['redPackCount']+1) . ' ,`lastTime`= ' . strval($_W['timestamp']). ' WHERE `uniacid` = '.strval($_W['uniacid']).' and `type` = \'kouling\' and `openid` = \''.$re_openid.'\'  '; $result2 = pdo_query($sql); $data = array( 'weid' => $_W['uniacid'], 'uid' => $fans_info['uid'], 'type' =>'kl', 'arc_name' =>$act_name, 'nick_name' => $nick_name, 'openid' => $re_openid, 'get_money' =>$moneyCount, 'get_time' =>TIMESTAMP, 'get_status' =>'SUCCESS', 'imgurl' =>$imgurl ); pdo_insert('han_hongbao_recordlist', $data); $successMsg = '恭喜你获得一个红包~'; echo $successMsg; return; } }else{ $time = date('Y-m-d H:i:s',time()); $sql = 'INSERT INTO'.tablename('han_hongbao_klrecord') .' (`uniacid`,`openid`,`nick_name`,`moneyCount`,`time`,`type`,`state`,`imgurl`,`content`) values ('. strval($_W['uniacid']).',\''.$re_openid.'\''.',\''.$nick_name.'\','.strval($moneyCount/100.0).',\''.$time.'\',\'kouling\',\'check\',\''.$imgurl.'\',\''.$content.'\')'; pdo_query($sql); $successMsg = '已提交成功，请等待审核！'; echo $successMsg; return; } } public function doWebYue() { global $_W, $_GPC; $op= $_GPC['op'] ? $_GPC['op'] : 'post'; if($op=='post'){ $id=$_GPC['id']; load()->model('module'); $url_show = murl('entry', array('do' => 'yedh', 'm' => 'han_hongbao'), true, true); load()->model('mc'); $groups = mc_groups(); $set= pdo_fetch("SELECT * FROM ".tablename('han_hongbao_yedh')." WHERE weid=:weid limit 1", array(':weid' => $_W['acid'])); $genders = array(0=>'不限制',1=>'只限男',2=>'只限女'); $gender = unserialize($set['gender']); $keywords = pdo_fetchcolumn('SELECT content FROM ' . tablename('rule_keyword') . ' WHERE id = :id AND uniacid = :uniacid ', array(':id' => $set['kid'], ':uniacid' => $_W['uniacid'])); if(checksubmit('submit')) { $citys = array(); foreach ($_GPC['citys'] as $value) { if (!empty($value)) $citys[] = $value; } if (!empty($citys)) $citys = serialize($citys); else $citys = ''; $data=array( 'weid'=>$_W['acid'], 'on_off'=>$_GPC['on_off'], 'title'=>$_GPC['title'], 'description'=>htmlspecialchars_decode(str_replace('&quot;','&#039;',$_GPC['description']),ENT_QUOTES), 'bgimg'=>$_GPC['bgimg'], 'shareimg'=>$_GPC['shareimg'], 'type'=>$_GPC['type'], 'intl'=>$_GPC['intl'], 'check'=>$_GPC['check'], 'oauth'=>$_GPC['oauth'], 'redirect'=>$_GPC['redirect'], 'gender'=>serialize($_GPC['genders']), 'province'=>$_GPC['place']['province'], 'city'=>$citys, 'area'=>$_GPC['place']['district'], 'need_rgst'=>$_GPC['need_rgst'], 'is_rlname'=>$_GPC['is_rlname'], 'mem_group'=>$_GPC['mem_group'] ); if(!empty($_GPC['keyword'])) { $rule['uniacid'] = $_W['uniacid']; $rule['name'] = $_GPC['title'] . ' 触发规则'; $rule['module'] = 'cover'; $rule['status'] = 1; $keyword = array('uniacid' => $_W['uniacid']); $keyword['module'] = 'cover'; $keyword['content'] = $_GPC['keyword']; $keyword['status'] = 1; $keyword['type'] = 1; $keyword['displayorder'] = 1; $reply = array('uniacid' => $_W['uniacid']); $reply['title'] = $_GPC['title']; $reply['module'] = 'han_hongbao'; $reply['do'] = 'yedh'; $reply['description'] = htmlspecialchars_decode(str_replace('&quot;','&#039;',$_GPC['description']),ENT_QUOTES); $reply['thumb'] = $data['bgimg']; $reply['url'] = murl('entry/module/yedh', array('m'=>'han_hongbao','id' => $id)); } if(empty($id)) { if(!empty($_GPC['keyword'])) { pdo_insert('rule', $rule); $rid = pdo_insertid(); $keyword['rid'] = $rid; pdo_insert('rule_keyword', $keyword); $kid = pdo_insertid(); $reply['rid'] = $rid; pdo_insert('cover_reply', $reply); $data['rid'] = $rid; $data['kid'] = $kid; } pdo_insert('han_hongbao_yedh', $data); $aid = pdo_insertid(); pdo_update('cover_reply', array('url' => murl('entry/module/yedh', array('m'=>'han_hongbao', 'id' => $aid))), array('rid' => $rid)); }else{ pdo_delete('rule', array('id' => $set['rid'], 'uniacid' => $_W['uniacid'])); pdo_delete('rule_keyword', array('rid' => $set['rid'], 'uniacid' => $_W['uniacid'])); pdo_delete('cover_reply', array('rid' => $set['rid'])); if(!empty($_GPC['keyword'])) { pdo_insert('rule', $rule); $rid = pdo_insertid(); $keyword['rid'] = $rid; pdo_insert('rule_keyword', $keyword); $kid = pdo_insertid(); $reply['rid'] = $rid; pdo_insert('cover_reply', $reply); $data['rid'] = $rid; $data['kid'] = $kid; } else { $data['rid'] = 0; $data['kid'] = 0; } pdo_update('han_hongbao_yedh',$data, array('id' => $id)); } message('余额兑换红包设置成功！','refresh', 'success'); } } include $this->template('yedh'); } public function doWebPutong() { global $_W, $_GPC; $op= $_GPC['op'] ? $_GPC['op'] : 'post'; $weid =$_W['uniacid']; $id=$_GPC['id']; load()->model('module'); $url_show = murl('entry', array('do' => 'putong', 'm' => 'han_hongbao'), true, true); $hours_time = pdo_fetchall("SELECT * FROM " . tablename('han_hongbao_time')); $set= pdo_fetch("SELECT * FROM ".tablename('han_hongbao_putong')." WHERE weid=:weid limit 1", array(':weid' => $weid)); $work_time = unserialize($set['hours_time']); load()->model('mc'); $groups = mc_groups(); $genders = array(0=>'不限制',1=>'只限男',2=>'只限女'); $gender = unserialize($set['gender']); $grades = array(1=>'不限制',2=>'已完善资料',3=>'已领取会员卡'); $num_grade = unserialize($set['num_grade']); $time=array( 'start' =>date('Y-m-d H:i:s', $set['starttime']), 'end' =>date('Y-m-d H:i:s', $set['endtime']), ); $keywords = pdo_fetchcolumn('SELECT content FROM ' . tablename('rule_keyword') . ' WHERE id = :id AND uniacid = :uniacid ', array(':id' => $set['kid'], ':uniacid' => $_W['uniacid'])); if(checksubmit('submit')) { $citys = array(); foreach ($_GPC['citys'] as $value) { if (!empty($value)) $citys[] = $value; } if (!empty($citys)) $citys = serialize($citys); else $citys = ''; $data=array( 'weid'=>$weid, 'arc_name'=>$_GPC['arc_name'], 'is_show'=>$_GPC['is_show'], 'is_check'=>$_GPC['is_check'], 'failed_url' =>$_GPC['failed_url'], 'starttime'=> strtotime($_GPC['time']['start']), 'endtime'=> strtotime($_GPC['time']['end']), 'moneymin'=>$_GPC['moneymin'], 'moneymax'=>$_GPC['moneymax'], 'no_total'=>$_GPC['no_total'], 'cool_time'=>$_GPC['cool_time'], 'title'=>$_GPC['title'], 'description'=>htmlspecialchars_decode(str_replace('&quot;','&#039;',$_GPC['description']),ENT_QUOTES), 'bgimg'=>$_GPC['bgimg'], 'shareimg'=>$_GPC['shareimg'], 'hours_time'=>serialize($_POST['hours']), 'createtime'=>TIMESTAMP, 'oauth'=>$_GPC['oauth'], 'redirect'=>$_GPC['redirect'], 'gender'=>serialize($_GPC['genders']), 'province'=>$_GPC['place']['province'], 'city'=>$citys, 'area'=>$_GPC['place']['district'], 'need_rgst'=>$_GPC['need_rgst'], 'mem_group'=>$_GPC['mem_group'] ); if(!empty($_GPC['keyword'])) { $rule['uniacid'] = $_W['uniacid']; $rule['name'] = $_GPC['title'] . ' 触发规则'; $rule['module'] = 'cover'; $rule['status'] = 1; $keyword = array('uniacid' => $_W['uniacid']); $keyword['module'] = 'cover'; $keyword['content'] = $_GPC['keyword']; $keyword['status'] = 1; $keyword['type'] = 1; $keyword['displayorder'] = 1; $reply = array('uniacid' => $_W['uniacid']); $reply['title'] = $_GPC['title']; $reply['module'] = 'han_hongbao'; $reply['do'] = 'putong'; $reply['description'] = htmlspecialchars_decode(str_replace('&quot;','&#039;',$_GPC['description']),ENT_QUOTES); $reply['thumb'] = $data['bgimg']; $reply['url'] = murl('entry/module/putong', array('m'=>'han_hongbao','id' => $id)); } if(empty($id)) { if(!empty($_GPC['keyword'])) { pdo_insert('rule', $rule); $rid = pdo_insertid(); $keyword['rid'] = $rid; pdo_insert('rule_keyword', $keyword); $kid = pdo_insertid(); $reply['rid'] = $rid; pdo_insert('cover_reply', $reply); $data['rid'] = $rid; $data['kid'] = $kid; } pdo_insert('han_hongbao_putong', $data); $aid = pdo_insertid(); pdo_update('cover_reply', array('url' => murl('entry/module/putong', array('m'=>'han_hongbao', 'id' => $aid))), array('rid' => $rid)); }else{ pdo_delete('rule', array('id' => $set['rid'], 'uniacid' => $_W['uniacid'])); pdo_delete('rule_keyword', array('rid' => $set['rid'], 'uniacid' => $_W['uniacid'])); pdo_delete('cover_reply', array('rid' => $set['rid'])); if(!empty($_GPC['keyword'])) { pdo_insert('rule', $rule); $rid = pdo_insertid(); $keyword['rid'] = $rid; pdo_insert('rule_keyword', $keyword); $kid = pdo_insertid(); $reply['rid'] = $rid; pdo_insert('cover_reply', $reply); $data['rid'] = $rid; $data['kid'] = $kid; } else { $data['rid'] = 0; $data['kid'] = 0; } pdo_update('han_hongbao_putong',$data, array('id' => $id)); } message('红包设置成功！','refresh', 'success'); } if($op == 'display'){ $sql = ""; $params = array(); $pindex = max(1, intval($_GPC['page'])); $psize = 20; $list = pdo_fetchall("SELECT * FROM " . tablename('han_hongbao_history') . " WHERE weid = '{$_W['uniacid']}' $sql ORDER BY get_time DESC LIMIT " . ($pindex - 1) * $psize . ',' . $psize, $params); $total = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('han_hongbao_history') . " WHERE weid = '{$_W['uniacid']}' $sql", $params); $pager = pagination($total, $pindex, $psize); }else if($op == 'delete'){ $id = intval($_GPC['id']); pdo_delete('han_hongbao_history', array('id' => $id)); message("活动信息删除成功!", referer(), "success"); } include $this->template('putong'); } public function doMobilePutong() { global $_W, $_GPC; $weid =$_W['uniacid']; $setting = $this->module['config']['api']; $set= pdo_fetch("SELECT * FROM ".tablename('han_hongbao_putong')." WHERE weid=:weid limit 1", array(':weid' => $weid)); $uid=$_W['member']['uid']; $member = pdo_fetch("SELECT * FROM ".tablename('mc_members') . " WHERE uid = :uid LIMIT 1", array(':uid' => $_W['member']['uid'])); if($set['oauth']==0){ if( $_W['fans']['follow'] == 0 ){ message('请先关注公众号'.$_W[account]['name'], $set['redirect'], "error"); } } if(empty($_GPC['code'])){ $callback = urlencode($_W['siteroot']."app/".$this->createMobileUrl('putong',array('pid'=>1),true)); $url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid={$setting['appid']}&redirect_uri={$callback}&response_type=code&scope=snsapi_userinfo&state=1#wechat_redirect"; header('location:'.$url); exit; } load()->func('communication'); $url = "https://api.weixin.qq.com/sns/oauth2/access_token?appid={$setting['appid']}&secret={$setting['secret']}&code={$_GPC['code']}&grant_type=authorization_code"; $res = ihttp_get($url); $res = @json_decode($res['content'],true); $url = "https://api.weixin.qq.com/sns/userinfo?access_token={$res['access_token']}&openid={$res['openid']}&lang=zh_CN"; $res = ihttp_get($url); $res = @json_decode($res['content'],true); $sex = $res['sex']; $sexs = unserialize($set['gender']); $out = true; if(!empty($sexs)){ if ($sex){ foreach ($sexs as $value) { if ($sex == $value || $value=='0'){ $out = false; } } if ($out){ $s =''; if($sex==1){$s ='女生';}else if($sex==2){$s ='男生';} message('该活动仅限制'.$s.'参加', '', "error"); } } } if($set['need_rgst']==1){ if(empty($member['realname'])||empty($member['mobile'])||empty($member['password'])){ header('Location:'. $_W['siteroot'] .'app/index.php?i='.$_W['uniacid'].'&c=mc&a=home'); } } $mem_group = $set['mem_group']; $group= pdo_fetch("SELECT * FROM ".tablename('mc_groups')." WHERE uniacid = :uniacid and groupid = :groupid limit 1", array(':uniacid' => $_W['uniacid'],':groupid'=>$mem_group)); $groupid = $member['groupid']; if(!empty($mem_group)&&$mem_group!=$groupid){ message('该活动仅限制'.$group['title'].'参加','', "error"); } $worktimes = unserialize($set['hours_time']); $jssdk = new JSSDK($_W['account']['key'], $_W['account']['secret']); $signPackage = $jssdk->GetSignPackage(); $hour = intval(date("G")); $min = intval(date("i")); $num=0; foreach($worktimes as $k => $val){ if($val>$hour&&($val-1)==$hour){ $num+=1; } } if(empty($_COOKIE['klhb_openid'.$_W['uniacid']])){ $url = $_W['siteroot'] . "app/index.php?i=".$_W['uniacid']."&j=".$_W['acid']."&c=entry&m=han_hongbao&do=xoauth"; $xoauthURL = $_W['siteroot'] . "app/index.php?i=".$_W['uniacid']."&j=".$_W['acid']."&c=entry&m=han_hongbao&do=putong"; setcookie("xoauthURL",$xoauthURL, time()+3600*(24*5)); $oauth2_code = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=".$setting['appid']."&redirect_uri=".urlencode($url)."&response_type=code&scope=snsapi_base&state=0#wechat_redirect"; header("location:$oauth2_code"); }else{ $errormsg=""; if(TIMESTAMP>$set['endtime']){ $errormsg="已结束"; if(!empty($set['failed_url'])){ message('现在非活动时间，请稍候...', $set['failed_url'], "error"); }else{ include $this->template('failed'); } }else if(TIMESTAMP<$set['starttime']){ $errormsg="尚未开始"; if(!empty($set['failed_url'])){ message('现在非活动时间，请稍候...', $set['failed_url'], "error"); }else{ include $this->template('failed'); } }else if(TIMESTAMP>$set['starttime']&&TIMESTAMP<$set['endtime']&&$set['is_show']=='0'){ $errormsg="暂时关闭"; if(!empty($set['failed_url'])){ message('现在非活动时间，请稍候...', $set['failed_url'], "error"); }else{ include $this->template('failed'); } }else if($num==0){ $errormsg="还未进入活动时间"; if(!empty($set['failed_url'])){ message('现在非活动时间，请稍候...', $set['failed_url'], "error"); }else{ include $this->template('failed'); } }else{ include $this->template('chaihongbao'); } } } public function doWebCheckyedh() { global $_W, $_GPC; $op= $_GPC['op'] ? $_GPC['op'] : 'display'; $weid =$_W['uniacid']; $access_token = $this->get_access_token(); $setting = $this->module['config']['api']; $set= pdo_fetch("SELECT * FROM ".tablename('han_hongbao_yedh')." WHERE weid=:weid limit 1", array(':weid' => $_W['acid'])); $mchid=$setting['mchid']; $password=$setting['password']; $appid=$setting['appid']; $desc = '余额兑换'; $ip = $setting['ip']; if($op == 'display'){ $sql = ""; $params = array(); $pindex = max(1, intval($_GPC['page'])); $psize = 20; $list = pdo_fetchall("SELECT * FROM " . tablename('han_hongbao_checklist') . " WHERE weid = '{$_W['uniacid']}' $sql ORDER BY get_time DESC LIMIT " . ($pindex - 1) * $psize . ',' . $psize, $params); $total = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('han_hongbao_checklist') . " WHERE weid = '{$_W['uniacid']}' $sql", $params); $pager = pagination($total, $pindex, $psize); }else if($op == 'delete'){ $id = intval($_GPC['id']); pdo_delete('han_hongbao_checklist', array('id' => $id)); message("余额兑换信息删除成功!", referer(), "success"); }else if($op == 'deleteall'){ foreach ($_GPC['idArr'] as $k => $id) { $id = intval($id); pdo_delete("han_hongbao_checklist", array("id" => $id)); } message("余额兑换信息删除成功!", referer(), "success"); }else if($op == 'check'){ $id = intval($_GPC['id']); $record= pdo_fetch("SELECT * FROM ".tablename('han_hongbao_checklist')." WHERE get_status='CHECK' and id=:id limit 1", array(':id' =>$id)); $nick_name = $record['nick_name']; $total_amount = $record['get_money']; $re_openid = $record['openid']; $uid = $record['uid']; $act_name = $record['arc_name']; $fans_info = pdo_fetch("SELECT * FROM " .tablename('mc_members'). " WHERE uniacid='{$_W['uniacid']}' AND uid='{$uid}' LIMIT 1"); $responseObj = $this->compay($mchid,$password,$appid,$fans_info['realname'],$re_openid,$total_amount,$ip,$desc,$set['is_rlname']); $result_code=$responseObj->result_code; $return_msg = $responseObj->err_code_des; $data = array( 'get_money' =>$total_amount, 'get_time' =>TIMESTAMP, 'get_status' =>$result_code, ); pdo_update('han_hongbao_checklist',$data, array('id' => $id)); if($result_code=='SUCCESS'){ $credit = array(); $msg =''; if($set['type']==0){$credit = array('credit1' => 0);$msg ='积分';} if($set['type']==1){$credit = array('credit2' => 0);$msg ='余额';} pdo_update('mc_members',$credit, array('uid' => $fans_info['uid'])); $rst = array( 'weid' => $weid, 'uid' => $fans_info['uid'], 'type' =>'ye', 'arc_name' =>$act_name, 'nick_name' => $nick_name, 'openid' => $re_openid, 'get_money' =>$total_amount, 'get_time' =>TIMESTAMP, 'get_status' =>$result_code, ); pdo_insert('han_hongbao_recordlist', $rst); message("余额兑发放成功!", referer(), "success"); }else{ message($return_msg.",余额兑发放失败!",referer(), "error"); } }else if($op == 'checkall'){ foreach ($_GPC['idArr'] as $k => $id) { $id = intval($id); $record= pdo_fetch("SELECT * FROM ".tablename('han_hongbao_checklist')." WHERE get_status='CHECK' and id=:id limit 1", array(':id' =>$id)); $nick_name = $record['nick_name']; $total_amount = $record['get_money']; $re_openid = $record['openid']; $uid = $record['uid']; $act_name = $record['arc_name']; $fans_info = pdo_fetch("SELECT * FROM " .tablename('mc_members'). " WHERE uniacid='{$_W['uniacid']}' AND uid='{$uid}' LIMIT 1"); $responseObj = $this->compay($mchid,$password,$appid,$fans_info['realname'],$re_openid,$total_amount,$ip,$desc,$set['is_rlname']); $result_code=$responseObj->result_code; $total_amount=$responseObj->total_amount; $return_msg = $responseObj->return_msg; $data = array( 'get_money' =>$total_amount, 'get_time' =>TIMESTAMP, 'get_status' =>$result_code, ); pdo_update('han_hongbao_checklist',$data, array('id' => $id)); if($result_code=='SUCCESS'){ $credit = array(); $msg =''; if($set['type']==0){$credit = array('credit1' => 0);$msg ='积分';} if($set['type']==1){$credit = array('credit2' => 0);$msg ='余额';} pdo_update('mc_members',$credit, array('uid' => $fans_info['uid'])); $rst = array( 'weid' => $weid, 'uid' => $fans_info['uid'], 'type' =>'ye', 'arc_name' =>$act_name, 'nick_name' => $nick_name, 'openid' => $re_openid, 'get_money' =>$total_amount, 'get_time' =>TIMESTAMP, 'get_status' =>$result_code, ); pdo_insert('han_hongbao_recordlist', $rst); } } message("批量操作成功，请检查是否发放成功!", referer(), "success"); } include $this->template('checklist'); } public function doMobileYedh() { global $_W, $_GPC; $weid =$_W['acid']; $setting = $this->module['config']['api']; $set= pdo_fetch("SELECT * FROM ".tablename('han_hongbao_yedh')." WHERE weid=:weid limit 1", array(':weid' => $weid)); $uid=$_W['member']['uid']; $member = pdo_fetch("SELECT * FROM ".tablename('mc_members') . " WHERE uid = :uid LIMIT 1", array(':uid' => $_W['member']['uid'])); if($set['oauth']==0){ if( $_W['fans']['follow'] == 0 ){ message('请先关注公众号'.$_W[account]['name'], $set['redirect'], "error"); } } if(empty($_GPC['code'])){ $callback = urlencode($_W['siteroot']."app/".$this->createMobileUrl('yedh',array('pid'=>1),true)); $url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid={$setting['appid']}&redirect_uri={$callback}&response_type=code&scope=snsapi_userinfo&state=1#wechat_redirect"; header('location:'.$url); exit; } load()->func('communication'); $url = "https://api.weixin.qq.com/sns/oauth2/access_token?appid={$setting['appid']}&secret={$setting['secret']}&code={$_GPC['code']}&grant_type=authorization_code"; $res = ihttp_get($url); $res = @json_decode($res['content'],true); $url = "https://api.weixin.qq.com/sns/userinfo?access_token={$res['access_token']}&openid={$res['openid']}&lang=zh_CN"; $res = ihttp_get($url); $res = @json_decode($res['content'],true); $sex = $res['sex']; $sexs = unserialize($set['gender']); $out = true; if(!empty($sexs)){ if ($sex){ foreach ($sexs as $value) { if ($sex == $value || $value=='0'){ $out = false; } } if ($out){ $s =''; if($sex==1){$s ='女生';}else if($sex==2){$s ='男生';} message('该活动仅限制'.$s.'参加', '', "error"); } } } if($set['need_rgst']==1){ if(empty($member['realname'])||empty($member['mobile'])||empty($member['password'])){ header('Location:'. $_W['siteroot'] .'/app/index.php?i='.$_W['uniacid'].'&c=mc&a=home'); } } $mem_group = $set['mem_group']; $group= pdo_fetch("SELECT * FROM ".tablename('mc_groups')." WHERE uniacid = :uniacid and groupid = :groupid limit 1", array(':uniacid' => $_W['uniacid'],':groupid'=>$mem_group)); $groupid = $member['groupid']; if(!empty($mem_group)&&$mem_group!=$groupid){ message('该活动仅限制'.$group['title'].'参加','', "error"); } $jssdk = new JSSDK($_W['account']['key'], $_W['account']['secret']); $signPackage = $jssdk->GetSignPackage(); if(empty($_COOKIE['klhb_openid'.$_W['uniacid']])){ $url = $_W['siteroot'] . "app/index.php?i=".$_W['uniacid']."&j=".$_W['acid']."&c=entry&m=han_hongbao&do=xoauth"; $xoauthURL = $_W['siteroot'] . "app/index.php?i=".$_W['uniacid']."&j=".$_W['acid']."&c=entry&m=han_hongbao&do=yedh"; setcookie("xoauthURL",$xoauthURL, time()+3600*(24*5)); $oauth2_code = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=".$setting['appid']."&redirect_uri=".urlencode($url)."&response_type=code&scope=snsapi_base&state=0#wechat_redirect"; header("location:$oauth2_code"); }else{ include $this->template('yedh_mobile'); } } public function doMobileCheckaddr() { global $_W, $_GPC; $tablename =$_GPC['tablename']; $set= pdo_fetch("SELECT * FROM ".tablename($tablename)." WHERE weid=:weid limit 1", array(':weid' => $_W['acid'])); $out = true; $city = unserialize($set['city']); if(!empty($city)){ if ($_GPC['pro']){ foreach ($city as $value) { if ($_GPC['city'] == $value || strstr($value,$_GPC['city']) || strstr($_GPC['city'],$value)){ $out = false; } } if ($out){ $result = array('code'=>'no','msg'=>'该活动仅限制'.implode(',',$city).'地区'); return json_encode($result); }else{ $result = array('code'=>'yes'); return json_encode($result); } } }else{ $result = array('code'=>'yes'); return json_encode($result); } } public function doMobilekouling() { global $_W, $_GPC; $jssdk = new JSSDK($_W['account']['key'], $_W['account']['secret']); $signPackage = $jssdk->GetSignPackage(); $set= pdo_fetch("SELECT * FROM ".tablename('han_hongbao_klset')." WHERE weid=:weid limit 1", array(':weid' => $_W['uniacid'])); $setting = $this->module['config']['api']; $uid=$_W['member']['uid']; $member = pdo_fetch("SELECT * FROM ".tablename('mc_members') . " WHERE uid = :uid LIMIT 1", array(':uid' => $_W['member']['uid'])); if($set['oauth']==0){ if( $_W['fans']['follow'] == 0 ){ message('请先关注公众号'.$_W[account]['name'], $set['redirect'], "error"); } } $sexs = unserialize($set['gender']); if(is_array($sexs)){ if(empty($_GPC['code'])){ $callback = urlencode($_W['siteroot']."app/".$this->createMobileUrl('kouling',array('pid'=>1),true)); $url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid={$setting['appid']}&redirect_uri={$callback}&response_type=code&scope=snsapi_userinfo&state=1#wechat_redirect"; header('location:'.$url); exit; } load()->func('communication'); $url = "https://api.weixin.qq.com/sns/oauth2/access_token?appid={$setting['appid']}&secret={$setting['secret']}&code={$_GPC['code']}&grant_type=authorization_code"; $res = ihttp_get($url); $res = @json_decode($res['content'],true); $url = "https://api.weixin.qq.com/sns/userinfo?access_token={$res['access_token']}&openid={$res['openid']}&lang=zh_CN"; $res = ihttp_get($url); $res = @json_decode($res['content'],true); $sex = $res['sex']; $out = true; if(!empty($sexs)){ if ($sex){ foreach ($sexs as $value) { if ($sex == $value || $value=='0'){ $out = false; } } if ($out){ $s =''; if($sex==1){$s ='女生';}else if($sex==2){$s ='男生';} message('该活动仅限制'.$s.'参加', '', "error"); } } } } if($set['need_rgst']==1){ if(empty($member['realname'])||empty($member['mobile'])||empty($member['password'])){ header('Location:'. $_W['siteroot'] .'/app/index.php?i='.$_W['uniacid'].'&c=mc&a=home'); } } $mem_group = $set['mem_group']; $group= pdo_fetch("SELECT * FROM ".tablename('mc_groups')." WHERE uniacid = :uniacid and groupid = :groupid limit 1", array(':uniacid' => $_W['uniacid'],':groupid'=>$mem_group)); $groupid = $member['groupid']; if(!empty($mem_group)&&$mem_group!=$groupid){ message('该活动仅限制'.$group['title'].'参加','', "error"); } if(empty($_COOKIE['klhb_openid'.$_W['uniacid']])){ $url = $_W['siteroot'] . "app/index.php?i=".$_W['uniacid']."&j=".$_W['acid']."&c=entry&m=han_hongbao&do=xoauth"; $xoauthURL = $_W['siteroot'] . "app/index.php?i=".$_W['uniacid']."&j=".$_W['acid']."&c=entry&m=han_hongbao&do=kouling"; setcookie("xoauthURL",$xoauthURL, time()+3600*(24*5)); $oauth2_code = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=".$setting['appid']."&redirect_uri=".urlencode($url)."&response_type=code&scope=snsapi_base&state=0#wechat_redirect"; header("location:$oauth2_code"); }else{ $img=""; if(empty($set['bgimg'])){ $img="../addons/han_hongbao/template/mobile/images/back.jpg"; }else{ $img=$_W['attachurl'].$set['bgimg']; } include $this->template('kouling'); } } public function doMobileSendhb(){ include_once('pay/WxHongBaoHelper.php'); global $_W, $_GPC; $uniacid = $_W['uniacid']; $account = $_W['account']; $setting = $this->module['config']['api']; $fans_info = pdo_fetch("SELECT * FROM " .tablename('mc_mapping_fans'). " WHERE uniacid='{$uniacid}' AND openid='{$_W['fans']['openid']}' LIMIT 1"); $record = pdo_fetch("SELECT * FROM " .tablename('han_hongbao_putong'). " WHERE weid = :uniacid LIMIT 1",array(':uniacid' =>$uniacid)); $re_openid = $_W['fans']['openid']; $nick_name = $_W['fans']['nickname'];; $send_name = $setting['send_name']; $total_amount = rand($record['moneymin'],$record['moneymax']); $wishing = $setting['wishing']; $remark = $setting['remark']; if(empty($remark)){ $remark='good luck!'; } $act_name = $record['arc_name']; $mchid=$setting['mchid']; $appid=$setting['appid']; $password=$setting['password']; $history = pdo_fetch("SELECT * FROM " .tablename('han_hongbao_history'). " WHERE get_status = 'SUCCESS' and weid = :uniacid and openid =:openid and arc_name =:arc_name LIMIT 1",array(':uniacid' =>$uniacid,':openid'=>$re_openid,':arc_name'=>$act_name)); $count = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('han_hongbao_history') . " WHERE get_status = 'SUCCESS' and uid = ".$fans_info['uid']." and weid=".$uniacid); if($count>=$record['no_total']){ $result = array('code'=>'out','msg'=>'你的领取次数已超过限制！'); return json_encode($result); } if(!empty($history )&& (TIMESTAMP-$history['get_time'])<$record['cool_time']*3600){ $result = array('code'=>'cool','msg'=>'现在是冷却时间，请稍后再试！'); return json_encode($result); } define('PARTNERKEY',$password); $mch_billno=$mchid.date('YmdHis').rand(1000, 9999); $commonUtil = new CommonUtil(); $wxHongBaoHelper = new WxHongBaoHelper(); $wxHongBaoHelper->setParameter("nonce_str", $commonUtil->create_noncestr()); $wxHongBaoHelper->setParameter("mch_billno", $mch_billno); $wxHongBaoHelper->setParameter("mch_id",$mchid); $wxHongBaoHelper->setParameter("wxappid", $appid); $wxHongBaoHelper->setParameter("nick_name",$nick_name); $wxHongBaoHelper->setParameter("send_name", $send_name); $wxHongBaoHelper->setParameter("re_openid",$_COOKIE['klhb_openid'.$uniacid]); $wxHongBaoHelper->setParameter("total_amount", $total_amount); $wxHongBaoHelper->setParameter("min_value", $total_amount); $wxHongBaoHelper->setParameter("max_value", $total_amount); $wxHongBaoHelper->setParameter("total_num", 1); $wxHongBaoHelper->setParameter("wishing",$wishing ); $wxHongBaoHelper->setParameter("client_ip", $setting['ip']); $wxHongBaoHelper->setParameter("act_name", $act_name); $wxHongBaoHelper->setParameter("remark",$remark); $postXml = $wxHongBaoHelper->create_hongbao_xml(); $url = 'https://api.mch.weixin.qq.com/mmpaymkttransfers/sendredpack'; $responseXml = $wxHongBaoHelper->curl_post_ssll($url, $postXml,$_W['uniacid']); $responseObj = simplexml_load_string($responseXml, 'SimpleXMLElement', LIBXML_NOCDATA); $return_code=$responseObj->return_code; $result_code=$responseObj->result_code; $total_amount=$responseObj->total_amount; $re_openid=$responseObj->re_openid; $data = array( 'weid' => $uniacid, 'uid' => $fans_info['uid'], 'arc_name' =>$act_name, 'nick_name' => $nick_name, 'openid' => $re_openid, 'get_money' =>$total_amount, 'get_time' =>TIMESTAMP, 'get_status' =>$result_code, ); pdo_insert('han_hongbao_history', $data); if($result_code=='SUCCESS'){ $data['type'] = 'pt'; pdo_insert('han_hongbao_recordlist', $data); } return json_encode($responseObj); } public function doMobileDhhb(){ include_once(MODULE_ROOT.'/pay'.DS.'WxHongBaoHelper.php'); global $_W, $_GPC; $uniacid = $_W['uniacid']; $account = $_W['account']; $access_token = $this->get_access_token(); $setting = $this->module['config']['api']; $set= pdo_fetch("SELECT * FROM ".tablename('han_hongbao_yedh')." WHERE weid=:weid limit 1", array(':weid' => $_W['acid'])); if(empty($set)){ $result = array('code'=>'no','msg'=>'活动不存在！'); return json_encode($result); } if($set['on_off']==0){ $result = array('code'=>'no','msg'=>'活动未开启！'); return json_encode($result); } $fans_info = pdo_fetch("SELECT * FROM " .tablename('mc_mapping_fans'). " WHERE uniacid='{$uniacid}' AND openid='{$_W['fans']['openid']}' LIMIT 1"); $re_openid = $_W['fans']['openid']; $nick_name = $_W['fans']['nickname']; if(($set['type']!=0&&$set['type']!=1)||$set['intl']<=0){ $result = array('code'=>'no','msg'=>'兑换参数设置有误！'); return json_encode($result); } $total_amount = $this->getamount($fans_info['uid'],$set['type'],$set['intl']); if($total_amount==0){ if($set['type']==0){ $result = array('code'=>'no','msg'=>'你没有足够的积分可以兑换！'); return json_encode($result); } if($set['type']==1){ $result = array('code'=>'no','msg'=>'你没有足够的余额可以兑换！'); return json_encode($result); } } $act_name = $set['title']; $mchid=$setting['mchid']; $appid=$setting['appid']; $data = array( 'weid' => $uniacid, 'uid' => $fans_info['uid'], 'arc_name' =>$act_name, 'nick_name' => $nick_name, 'openid' => $re_openid, 'get_money' =>$total_amount, 'get_time' =>TIMESTAMP, 'get_status' =>'CHECK', ); $ip = $setting['ip']; $password = $setting['password']; $desc ='余额兑换'; $responseObj =array(); if(intval($set['check'])==0){ $responseObj = $this->compay($mchid,$password,$appid,$nick_name,$re_openid,$total_amount,$ip,$desc,$set['is_rlname']); $result_code=$responseObj->result_code; if($result_code=='SUCCESS'){ $credit = array(); $msg =''; if($set['type']==0){$credit = array('credit1' => 0);$msg ='积分';} if($set['type']==1){$credit = array('credit2' => 0);$msg ='余额';} pdo_update('mc_members',$credit, array('uid' => $fans_info['uid'])); $data['openid'] = $re_openid; $data['get_money'] = $total_amount; $data['get_status'] = $result_code; $data['type'] = 'ye'; pdo_insert('han_hongbao_recordlist', $data); $postarr='{"touser":"'.$_W['openid'].'","msgtype":"text","text":{"content":"您'.$msg.'兑换获得'.$total_amount*0.01.'元红包"}}'; $res = ihttp_post('https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=' . $access_token, $postarr); } $data['get_status'] = $result_code; pdo_insert('han_hongbao_checklist', $data); }else{ $responseObj = array('code'=>'no','msg'=>'提交成功，请等待审核！'); pdo_insert('han_hongbao_checklist', $data); } return json_encode($responseObj); } public function pay($mchid,$password,$appid,$nick_name,$send_name,$re_openid,$total_amount,$wishing,$ip,$act_name,$remark){ include_once('pay/WxHongBaoHelper.php'); global $_W, $_GPC; define('PARTNERKEY',$password); $mch_billno=$mchid.date('YmdHis').rand(1000, 9999); $commonUtil = new CommonUtil(); $wxHongBaoHelper = new WxHongBaoHelper(); $wxHongBaoHelper->setParameter("nonce_str", $commonUtil->create_noncestr()); $wxHongBaoHelper->setParameter("mch_billno", $mch_billno); $wxHongBaoHelper->setParameter("mch_id",$mchid); $wxHongBaoHelper->setParameter("wxappid", $appid); $wxHongBaoHelper->setParameter("nick_name",$nick_name); $wxHongBaoHelper->setParameter("send_name",$send_name); $wxHongBaoHelper->setParameter("re_openid",$re_openid); $wxHongBaoHelper->setParameter("total_amount",$total_amount); $wxHongBaoHelper->setParameter("min_value",$total_amount); $wxHongBaoHelper->setParameter("max_value",$total_amount); $wxHongBaoHelper->setParameter("total_num",1); $wxHongBaoHelper->setParameter("wishing",$wishing ); $wxHongBaoHelper->setParameter("client_ip",$ip); $wxHongBaoHelper->setParameter("act_name",$act_name); $wxHongBaoHelper->setParameter("remark",$remark); $postXml = $wxHongBaoHelper->create_hongbao_xml(); $url = 'https://api.mch.weixin.qq.com/mmpaymkttransfers/sendredpack'; $responseXml = $wxHongBaoHelper->curl_post_ssll($url, $postXml,$_W['uniacid']); $responseObj = simplexml_load_string($responseXml, 'SimpleXMLElement', LIBXML_NOCDATA); return $responseObj; } public function compay($mchid,$password,$appid,$realname,$re_openid,$total_amount,$ip,$desc,$is_rlname){ include_once('pay/WxHongBaoCompay.php'); global $_W, $_GPC; define('PARTNERKEY',$password); $mch_billno=$mchid.date('YmdHis').rand(1000, 9999); $check_name = 'NO_CHECK'; if(intval($is_rlname)==1){$check_name = 'OPTION_CHECK';} $commonUtil = new CommonUtil(); $wxHongBaoHelper = new WxHongBaoCompay(); $wxHongBaoHelper->setParameter("mch_appid", $appid); $wxHongBaoHelper->setParameter("mchid",$mchid); $wxHongBaoHelper->setParameter("nonce_str", $commonUtil->create_noncestr()); $wxHongBaoHelper->setParameter("partner_trade_no", $mch_billno); $wxHongBaoHelper->setParameter("openid",$re_openid); $wxHongBaoHelper->setParameter("check_name",$check_name); $wxHongBaoHelper->setParameter("re_user_name",$realname); $wxHongBaoHelper->setParameter("amount",$total_amount); $wxHongBaoHelper->setParameter("desc",$desc); $wxHongBaoHelper->setParameter("spbill_create_ip",$ip); $postXml = $wxHongBaoHelper->create_hongbao_xml(); $url = 'https://api.mch.weixin.qq.com/mmpaymkttransfers/promotion/transfers'; $responseXml = $wxHongBaoHelper->curl_post_ssll($url, $postXml,$_W['uniacid']); $responseObj = simplexml_load_string($responseXml, 'SimpleXMLElement', LIBXML_NOCDATA); return $responseObj; } private function getamount($uid,$type,$intl){ global $_W, $_GPC; $uniacid = $_W['uniacid']; $mem_info = pdo_fetch("SELECT * FROM " .tablename('mc_members'). " WHERE uniacid='{$uniacid}' AND uid='{$uid}' LIMIT 1"); $amount =0; if($mem_info){ if($type==0){ $amount = intval($mem_info['credit1'])/intval($intl); if($amount<1){ $amount =0; }else{ $amount =$amount*100; } } if($type==1){ $amount = intval($mem_info['credit2'])/intval($intl); if($amount<1){ $amount =0; }else{ $amount =$amount*100; } } } return $amount; } private function getMediaImg($serverId, $savePath) { $access_token = $this->get_access_token(); load()->func('communication'); $url="http://file.api.weixin.qq.com/cgi-bin/media/get?access_token=$access_token&media_id=$serverId"; $resp = ihttp_request($url); if(is_error($resp)) { load()->func('logging'); logging_run($resp); return $savePath; } if ($resp['headers']['Content-Type']=="image/png"){ $ftype="png"; } else if ($resp['headers']['Content-Type']=="image/jpg") { $ftype="jpg"; } else if ($resp['headers']['Content-Type']=="image/jpeg") { $ftype="jpeg"; } else { load()->func('logging'); logging_run($resp['headers']); return $savePath; } $savePath=$savePath.time().rand(1,1000).".".$ftype; $local_file=@fopen($savePath,'w'); if(false!==$local_file){ if(false!==fwrite($local_file,$resp['content'])){ fclose($local_file); } } return $savePath; } private function get_access_token(){ global $_W; $weid = $_W['uniacid']; load()->model('account'); $_W['account'] = account_fetch($_W['acid']); $appId =$_W['account']['key']; $appSecret =$_W['account']['secret']; $access_token = $_W['account']['access_token']['token']; $expire = $_W['account']['access_token']['expire']; if (!empty($access_token) && $expire > time()) { } else { $url = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid={$appId}&secret={$appSecret}"; $result = json_decode(file_get_contents($url), 1); $access_token = $result["access_token"]; if ($access_token) { $data = json_decode(file_get_contents(IA_ROOT . '/addons/han_hongbao/access_token.json')); $data->expire_time = time() + 3600; $data->access_token = $access_token; file_put_contents(IA_ROOT . '/addons/han_hongbao/access_token.json', json_encode($data)); $record = array(); $record['token'] = $access_token; $record['expire'] = time() + 3600; $row = array(); $row['access_token'] = iserializer($record); pdo_update('account_wechats', $row, array('uniacid' => $weid)); } } return $access_token; } public function doMobileXoauth(){ global $_W,$_GPC; if ($_GPC['code']=="authdeny" || empty($_GPC['code'])) { exit("授权失败"); } load()->func('communication'); $appid=$this->module['config']['api']['appid']; $secret=$this->module['config']['api']['secret']; $state = $_GPC['state']; $code = $_GPC['code']; $oauth2_code = "https://api.weixin.qq.com/sns/oauth2/access_token?appid=".$appid."&secret=".$secret."&code=".$code."&grant_type=authorization_code"; $content = ihttp_get($oauth2_code); $token = @json_decode($content['content'], true); if(empty($token) || !is_array($token) || empty($token['access_token']) || empty($token['openid'])) { echo '<h1>获取微信公众号授权'.$code.'失败[无法取得token以及openid], 请稍后重试！ 公众平台返回原始数据为: <br />' . $content['meta'].'<h1>'; exit; } $from_user = $token['openid']; $weid = $_W['uniacid']; setcookie('klhb_openid'.$weid,$from_user, time()+3600*(24*5)); $url=$_COOKIE["xoauthURL"]; header("location:$url"); exit(); } private function placeLimit($addr,$set){ $out = true; $city = unserialize($set['city']); foreach ($city as $value) { if ($addr['city'] == $value || strstr($value,$addr['city']) || strstr($addr['city'],$value)){ $out = false; } } if ($out){ header('location:'.$_W['attachurl'].$set['bgimg']); exit; } } }

?>